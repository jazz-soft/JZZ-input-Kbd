!function(t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t.Kbd=t:"function"==typeof define&&define.amd?define("JZZ.input.Kbd",["JZZ"],t):t(JZZ)}(function(h){if(h){h.input||(h.input={});for(var n,e="1.3.2",r={a:10,b:11,c:12,d:13,e:14,f:15,A:10,B:11,C:12,D:13,E:14,F:15},t=0;t<16;t++)r[t]=t;s.prototype.channel=function(t){return void 0===this.mpe&&void 0!==(t=r[t])&&(this.chan=t),this.chan},c.prototype._info=function(t){return{type:"html/javascript",name:i(t,"ASCII"),manufacturer:"virtual",version:e}},c.prototype._openIn=function(i,t){var e=new s(this._arg);e.port=i,e.mpe?(i._orig._mpe||(i._orig._mpe=h.MPE()),i._orig._mpe.setup(e.mpe[0],e.mpe[1]),e.noteOn=function(t){var e=h.MIDI(144+this.chan,t,127);e._mpe=t,i._receive(e)},e.noteOff=function(t){var e=h.MIDI(128+this.chan,t,127);e._mpe=t,i._receive(e)}):(e.noteOn=function(t){i._receive(h.MIDI(144+this.chan,t,127))},e.noteOff=function(t){i._receive(h.MIDI(128+this.chan,t,127))}),i._info=this._info(t),i._close=function(){e._close()},i.channel=function(t){return e.channel(t)},i._resume()},h.input.ASCII=function(){1==arguments.length?"string"==typeof arguments[0]?t=arguments[0]:e=arguments[0]:(t=arguments[0],e=arguments[1]);var t,e,i=new c;return i._arg=e,h.lib.openMidiIn(t,i)},h.input.ASCII.register=function(){1==arguments.length?"string"==typeof arguments[0]?t=arguments[0]:e=arguments[0]:(t=arguments[0],e=arguments[1]);var t,e,i=new c;return i._arg=e,h.lib.registerMidiIn(t,i)},y.prototype.channel=function(t){if(void 0===this.mpe){t=r[t];if(void 0!==t&&t!=this.chan){for(var e in this.playing)_(this.keys[e],(this.keys[e]._active?this.stl0:this.stl2)[e]),_(this.keys[e],this.locs[e]);this.chan=t}}return this.chan},y.prototype._close=function(){for(var t in this.playing)"M"!=this.playing[t]&&"T"!=this.playing[t]||this.noteOff(t);this.resize&&window.removeEventListener("resize",this.resize),this.cleanup()},y.prototype.press=function(t){this.keys[t]._active&&(_(this.keys[t],this.stl1[t]),_(this.keys[t],this.locs[t]),this.noteOn(t))},y.prototype.release=function(t){this.keys[t]._active&&(_(this.keys[t],this.stl0[t]),_(this.keys[t],this.locs[t]),this.noteOff(t))},y.prototype.forward=function(t){var e=t[1],i=t.getChannel();if(i>=this.chan&&i<=(this.mpe?this.chan+this.mpe[1]:this.chan)){i=t[0]>>4;if(t.isNoteOn())this.keys[e]&&(this.playing[e]="E",_(this.keys[e],this.stl1[e]),_(this.keys[e],this.locs[e]));else if(t.isNoteOff())this.keys[e]&&(this.playing[e]=void 0,_(this.keys[e],(this.keys[e]._active?this.stl0:this.stl2)[e]),_(this.keys[e],this.locs[e]));else if(11==i&&(120==e||123==e))for(e in this.playing)this.playing[e]=void 0,_(this.keys[e],(this.keys[e]._active?this.stl0:this.stl2)[e]),_(this.keys[e],this.locs[e])}this.emit(t)},y.prototype.clear=function(){for(var t in this.playing)this.playing[t]=void 0,_(this.keys[t],(this.keys[t]._active?this.stl0:this.stl2)[t]),_(this.keys[t],this.locs[t])},y.prototype.findKey=function(t,e,i){for(var s in this.keys)for(var n=document.elementFromPoint(t,e);n;n=n.parentNode)if(this.keys[s]==n)return void(i[s]=!0)},y.prototype.create=function(){for(var t=0,e=0;e<this.bins.length&&this.bins[e]<=window.innerWidth;e++)t=this.bins[e];this.current=this.params[t],this.createCurrent()},y.prototype.createCurrent=function(){if(this.cleanup(),this.keys={},this.locs={},this.stl0={},this.stl1={},this.stl2={},this.playing={},this.touches={},this.current.ul||(this.current.ul=m(this.current.wl,this.current.bl),this.current.wl=parseInt(this.current.wl),this.current.bl=parseInt(this.current.bl)),this.current.uw||(this.current.uw=m(this.current.ww,this.current.bw),this.current.ww=parseInt(this.current.ww),this.current.bw=parseInt(this.current.bw)),this.current.keys)this.createWithKeys(this.current.keys);else{"string"==typeof this.current.at&&(this.current.at=document.getElementById(this.current.at));try{this.createAt(this.current.at)}catch(t){this.bottom||(this.bottom=document.createElement("div"),document.body.appendChild(this.bottom)),this.createAt(this.bottom)}}},y.prototype.createWithKeys=function(t){for(var e in t){var i=h.MIDI.noteValue(t[e][1]),e=t[e][0];"string"==typeof e&&(e=document.getElementById(e)),this.keys[i]=e,this.locs[i]={},this.stl0[i]={},this.stl1[i]={},this.stl2[i]={}}this.setListeners(),this.current.onCreate&&this.current.onCreate.apply(this)},y.prototype.createAt=function(t){t.innerHTML="";var e,i,s=this.current.pos.toUpperCase(),n=M(this.current.from),o=M(this.current.to,!0),r=o-n+1,h=r*this.current.ww,a=this.current.wl,u=this.current.ul,c=this.current.uw,p=this.current.ww,l=this.current.wl,d=this.current.bw,f=this.current.bl,v=("%"!=c&&(h++,p--,d--),"%"!=u&&(a++,l--,f--),"N"!=s^!this.current.rev),y="E"!=s^!this.current.rev,m=document.createElement("span");m.style.display="inline-block",m.style.position="relative",m.style.margin="0px",m.style.padding="0px",m.style.borderStyle="none",m.style.userSelect="none",m.style.MozUserSelect="none",m.style.WebkitUserSelect="none",m.style.MsUserSelect="none",m.style.KhtmlUserSelect="none",m.style.cursor="default","E"==s||"W"==s?(m.style.width=a+u,m.style.height=h+c):(m.style.width=h+c,m.style.height=a+u);for(var b=0;b<r;b++)k=S(b+n),e=document.createElement("span"),this.keys[k]=e,this.locs[k]=i={display:"inline-block",position:"absolute",margin:"0px",padding:"0px",borderStyle:"solid",borderWidth:"1px"},"E"==s||"W"==s?(i.width=l+u,i.height=p+c,i.left="0px",i[y?"top":"bottom"]=this.current.ww*b+c):(i.width=p+c,i.height=l+u,i.top="0px",i[v?"left":"right"]=this.current.ww*b+c,i.verticalAlign="top"),this.stl0[k]={backgroundColor:"#fff",borderColor:"#000"},this.stl1[k]={backgroundColor:"#aaa",borderColor:"#000"},this.stl2[k]={backgroundColor:"#fff",borderColor:"#000"},_(e,this.stl0[k]),_(e,i),m.appendChild(e);for(var g=Math.ceil(this.current.ww-3*this.current.bw/4),h=((g+this.current.ww)%2&&g--,S(n)+1),w=S(o),k=h;k<w;k++){var x,I=k%12,E=Math.floor(k/12);if(1==I)x=Math.floor(this.current.ww*(7*E+1.5-n))-g/2-this.current.bw;else if(3==I)x=Math.floor(this.current.ww*(7*E+1.5-n)+g/2);else if(6==I)x=this.current.ww*(7*E+5-n)-Math.floor(this.current.bw/2)-g-this.current.bw;else if(8==I)x=this.current.ww*(7*E+5-n)-Math.floor(this.current.bw/2);else{if(10!=I)continue;x=this.current.ww*(7*E+5-n)-Math.floor(this.current.bw/2)+g+this.current.bw}e=document.createElement("span"),this.keys[k]=e,this.locs[k]=i={display:"inline-block",position:"absolute",margin:"0px",padding:"0px",borderStyle:"solid",borderWidth:"1px"},"E"==s||"W"==s?(i.width=f+u,i.height=d+c,i["E"==s?"right":"left"]="0px",i[y?"top":"bottom"]=x+c):(i.width=d+c,i.height=f+u,i["N"==s?"top":"bottom"]="0px",i[v?"left":"right"]=x+c),this.stl0[k]={backgroundColor:"#000",borderColor:"#000"},this.stl1[k]={backgroundColor:"#888",borderColor:"#000"},this.stl2[k]={backgroundColor:"#000",borderColor:"#000"},_(e,this.stl0[k]),_(e,i),m.appendChild(e)}t.appendChild(m),this.current.at=t,this.at=t,this.setListeners(),this.current.onCreate&&this.current.onCreate.apply(this)},y.prototype.setListeners=function(){var t,e,o,i,s=void 0===this.current.active||!!this.current.active;for(t in this.watchButtons=function(t){n=t.buttons},this.mouseUpHandle=(e=this,function(t){d(t=p(t))&&(e.mouseDown=!1)}),window.addEventListener("mousedown",this.watchButtons),window.addEventListener("mousemove",this.watchButtons),window.addEventListener("mouseup",this.mouseUpHandle),this.touchHandle=(o=this,function(t){t.preventDefault();for(var e={},i=0;i<t.touches.length;i++)o.findKey(t.touches[i].clientX,t.touches[i].clientY,e);var s,n={};for(s in e)s in o.touches?n[s]=!0:void 0===o.playing[s]&&(o.playing[s]="T",o.press(s),n[s]=!0);for(s in o.touches)s in e||(o.playing[s]=void 0,o.release(s));o.touches=n}),this.mouseDownH=[],this.mouseOverH=[],this.mouseOutH=[],this.mouseUpH=[],this.keys)this.mouseDownH[t]=function(e,i){return function(t){l(t)&&!e.playing[i]&&(e.mouseDown=!0,e.playing[i]="M",e.press(i)),n=t.buttons}}(this,t),this.mouseOverH[t]=function(e,i){return function(t){e.mouseDown&&!e.playing[i]&&(e.playing[i]="M",e.press(i)),n=t.buttons}}(this,t),this.mouseOutH[t]=v(this,t),this.mouseUpH[t]=function(e,i){return function(t){d(t=p(t))&&e.mouseDown&&"M"==e.playing[i]&&(e.playing[i]=void 0,e.release(i),e.mouseDown=!1)}}(this,t),this.keys[t].addEventListener("mousedown",this.mouseDownH[t]),this.keys[t].addEventListener("mouseover",this.mouseOverH[t]),this.keys[t].addEventListener("mouseout",this.mouseOutH[t]),this.keys[t].addEventListener("mouseup",this.mouseUpH[t]),this.keys[t].addEventListener("touchstart",this.touchHandle),this.keys[t].addEventListener("touchmove",this.touchHandle),this.keys[t].addEventListener("touchend",this.touchHandle),this.keys[t].addEventListener("touchcancel",this.touchHandle);for(t in this.keys)void 0===this.keys[t]._active&&(this.keys[t]._active=s),this.keys[t].ondragstart=f,this.keys[t].onselectstart=f;!this.resize&&1<this.bins.length&&((i=this).resize=function(){i.onResize()},window.addEventListener("resize",this.resize))},y.prototype.cleanup=function(){for(var t in this.watchButtons&&(window.removeEventListener("mousedown",this.watchButtons),window.removeEventListener("mousemove",this.watchButtons),window.removeEventListener("mouseup",this.mouseUpHandle)),this.keys)this.mouseDownH[t]&&this.keys[t].removeEventListener("mousedown",this.mouseDownH[t]),this.mouseOverH[t]&&this.keys[t].removeEventListener("mouseover",this.mouseOverH[t]),this.mouseOutH[t]&&this.keys[t].removeEventListener("mouseout",this.mouseOutH[t]),this.mouseUpH[t]&&this.keys[t].removeEventListener("mouseup",this.mouseUpH[t]),this.touchHandle&&(this.keys[t].removeEventListener("touchstart",this.touchHandle),this.keys[t].removeEventListener("touchmove",this.touchHandle),this.keys[t].removeEventListener("touchend",this.touchHandle),this.keys[t].removeEventListener("touchcancel",this.touchHandle));this.at&&(this.at.innerHTML="")},y.prototype.settings=function(){return a(this.current)},y.prototype.onResize=function(){for(var t=0,e=0;e<this.bins.length&&this.bins[e]<=window.innerWidth;e++)t=this.bins[e];this.current!=this.params[t]&&(this.current=this.params[t],this.createCurrent())},y.prototype.enable=function(){for(var t in this.keys)this.keys[t]._active=!0;return this},y.prototype.disable=function(){for(var t in this.keys)this.keys[t]._active=!1;return this},y.prototype.getKey=function(t){var e=new b(this),t=h.MIDI.noteValue(t);return void 0!==this.keys[t]&&e.keys.push(t),e},y.prototype.getKeys=function(t,e){var i,s=new b(this),n=void 0===t?void 0:h.MIDI.noteValue(t),o=void 0===e?void 0:h.MIDI.noteValue(e);for(i in void 0!==n&&void 0!==o&&o<n&&(t=n,n=o,o=t),this.keys)void 0!==n&&i<n||void 0!==o&&o<i||s.keys.push(i);return s},y.prototype.getWhiteKeys=function(t,e){var i,s,n=new b(this),o=void 0===t?void 0:h.MIDI.noteValue(t),r=void 0===e?void 0:h.MIDI.noteValue(e);for(i in void 0!==o&&void 0!==r&&r<o&&(t=o,o=r,r=t),this.keys)void 0!==o&&i<o||void 0!==r&&r<i||1!=(s=i%12)&&3!=s&&6!=s&&8!=s&&10!=s&&n.keys.push(i);return n},y.prototype.getBlackKeys=function(t,e){var i,s,n=new b(this),o=void 0===t?void 0:h.MIDI.noteValue(t),r=void 0===e?void 0:h.MIDI.noteValue(e);for(i in void 0!==o&&void 0!==r&&r<o&&(t=o,o=r,r=t),this.keys)void 0!==o&&i<o||void 0!==r&&r<i||1!=(s=i%12)&&3!=s&&6!=s&&8!=s&&10!=s||n.keys.push(i);return n},b.prototype.setInnerHTML=function(t){for(var e in this.keys)this.piano.keys[this.keys[e]].innerHTML=t;return this},b.prototype.setStyle=function(t,e,i){var s,n,o;for(s in void 0===e&&(e=t),void 0===i&&(i=t),this.keys){for(n in o=this.keys[s],t)this.piano.stl0[o][n]=t[n];for(n in e)this.piano.stl1[o][n]=e[n];for(n in i)this.piano.stl2[o][n]=i[n];_(this.piano.keys[o],(this.piano.playing[o]?this.piano.stl1:this.piano.keys[o]._active?this.piano.stl0:this.piano.stl2)[o]),_(this.piano.keys[o],this.piano.locs[o])}return this},b.prototype.enable=function(){var t,e;for(t in this.keys)e=this.keys[t],this.piano.keys[e]._active=!0,_(this.piano.keys[e],(this.piano.playing[e]?this.piano.stl1:this.piano.stl0)[e]),_(this.piano.keys[e],this.piano.locs[e]);return this},b.prototype.disable=function(){var t,e;for(t in this.keys)e=this.keys[t],this.piano.keys[e]._active=!1,_(this.piano.keys[e],(this.piano.playing[e]?this.piano.stl1:this.piano.stl2)[e]),_(this.piano.keys[e],this.piano.locs[e]);return this},g.prototype._info=function(t){return{type:"html/javascript",name:i(t,"Kbd"),manufacturer:"virtual",version:e}},g.prototype._openIn=function(i,t){var s=new y(this._arg);s.send=function(){i.send.apply(i,arguments)},s.connect=function(){i.connect.apply(i,arguments)},s.create(),s.mpe?(i._orig._mpe||(i._orig._mpe=h.MPE()),i._orig._mpe.setup(s.mpe[0],s.mpe[1]),s.noteOn=function(t){var e=h.MIDI(144+this.chan,t,127);e._mpe=t,i._emit(i._filter(e))},s.noteOff=function(t){var e=h.MIDI(128+this.chan,t,127);e._mpe=t,i._emit(i._filter(e))}):(s.noteOn=function(t){i._emit(h.MIDI(144+this.chan,t,127))},s.noteOff=function(t){i._emit(h.MIDI(128+this.chan,t,127))}),s.emit=function(t){i._emit(i._filter(t))},i._info=this._info(t),i._receive=function(t){s.forward(t)},i._close=function(){s._close()},i.settings=function(){return s.settings()},i.getKey=function(t){return s.getKey(t)},i.getKeys=function(t,e){return s.getKeys(t,e)},i.getWhiteKeys=function(t,e){return s.getWhiteKeys(t,e)},i.getBlackKeys=function(t,e){return s.getBlackKeys(t,e)},i.channel=function(t){return s.channel(t)},i.clear=function(){return s.clear()},i._resume()},h.input.Kbd=function(){1==arguments.length?"string"==typeof arguments[0]?t=arguments[0]:e=arguments[0]:(t=arguments[0],e=arguments[1]);var t,e,i=new g;return i._arg=e,h.lib.openMidiIn(t,i)},h.input.Kbd.version=function(){return e},h.input.Kbd.register=function(){1==arguments.length?"string"==typeof arguments[0]?t=arguments[0]:e=arguments[0]:(t=arguments[0],e=arguments[1]);var t,e,i=new g;return i._arg=e,h.lib.registerMidiIn(t,i)};var u={margin:0,padding:0,width:"100%",height:"100%"};w.prototype.setBase=function(t){t=parseFloat(t),!isNaN(t)&&isFinite(t)&&0<=t&&t<=1&&(this.base=t)},w.prototype.setValue=function(t){if(t=parseFloat(t),!(isNaN(t)||!isFinite(t)||t<0||1<t||t==this.val))return this.val=t,this.num=Math.round(t*(this.lsb||!this.msb?16383:127)),!0},w.prototype.emit=function(t){this.msb?this.lsb?(t.emit([176+this.chan,this.msb,this.num>>7]),t.emit([176+this.chan,this.lsb,127&this.num])):t.emit([176+this.chan,this.msb,this.num]):t.emit([224+this.chan,127&this.num,this.num>>7])},w.prototype.read=function(t){return this.msb||t[0]!=224+this.chan||t[1]!=parseInt(t[1])||t[2]!=parseInt(t[2])?this.msb&&t[0]==176+this.chan&&t[2]==parseInt(t[2])?t[1]==this.msb?(this.lsb?(this.num=t[2]<<7|127&this.num,this.val=this.num/16383):(this.num=127&t[2],this.val=this.num/127),!0):t[1]==this.lsb?(this.num=16256&this.num|127&t[2],this.val=this.num/16383,!0):void 0:void 0:(this.num=t[2]<<7|127&t[1],this.val=this.num/16383,!0)},k.prototype.setInnerHTML=function(t){return this.inner.innerHTML=t,this},k.prototype.setStyle=function(t,e){for(var i in void 0===e&&(e=t),t)this.stl0[i]=t[i];for(i in e)this.stl1[i]=e[i];return _(this.span,this.ctrl.isSelected()?this.stl1:this.stl0),_(this.span,this.stl),this},x.prototype._close=function(){this.at&&(this.at.innerHTML=""),this.mouseUpHandler&&window.removeEventListener("mouseup",this.mouseUpHandler)},x.prototype.create=function(){for(var t=0,e=0;e<this.bins.length&&this.bins[e]<=window.innerWidth;e++)t=this.bins[e];this.current=this.params[t],this.createCurrent()},x.prototype.createCurrent=function(){this.at&&(this.at.innerHTML=""),"string"==typeof this.current.at&&(this.current.at=document.getElementById(this.current.at));try{this.createAt(this.current.at)}catch(t){this.bottom||(this.bottom=document.createElement("div"),document.body.appendChild(this.bottom)),this.createAt(this.bottom)}},x.prototype.onResize=function(){for(var t=0,e=0;e<this.bins.length&&this.bins[e]<=window.innerWidth;e++)t=this.bins[e];this.current!=this.params[t]&&(this.current=this.params[t],this.createCurrent())},x.prototype.settings=function(){return a(this.current)},x.prototype.isSelected=function(){return void 0!==this.dragX},x.prototype.restyle=function(){for(var t in this.spans)this.spans[t].setStyle()},x.prototype.onMouseDown=function(t){var e,i;void 0===this.dragX&&(this.dragX=t.clientX,this.dragY=t.clientY,this.mouseMove=(e=this,function(t){n=t.buttons,e.onMouseMove(t)}),this.mouseUp=(i=this,function(t){d(t=p(t))&&(window.removeEventListener("mousemove",i.mouseMove),window.removeEventListener("mouseup",i.mouseUp),i.dragX=void 0,i.restyle(),i.onMouseUp(t))}),window.addEventListener("mousemove",this.mouseMove),window.addEventListener("mouseup",this.mouseUp),this.restyle())},x.prototype.onMouseMove=function(t){void 0!==this.dragX&&this.onMove(t.clientX,t.clientY)},x.prototype.onMouseUp=function(){},x.prototype.onTouchStart=function(t){t.preventDefault(),void 0===this.dragX&&(this.touch=t.targetTouches[0].identifier,this.dragX=t.targetTouches[0].clientX,this.dragY=t.targetTouches[0].clientY,this.restyle())},x.prototype.onTouchMove=function(t){if(t.preventDefault(),void 0!==this.dragX&&void 0!==this.touch)for(var e in t.targetTouches)if(t.targetTouches[0].identifier==this.touch)return void this.onMove(t.targetTouches[e].clientX,t.targetTouches[e].clientY)},x.prototype.onTouchEnd=function(t){t.preventDefault(),this.touch=void 0,this.dragX=void 0,this.restyle(),this.onMouseUp(t)},(X.prototype=new x).channel=function(t){t=r[t];return void 0!==t&&t!=this.chan&&(this.chan=t,this.data.chan=t,this.setValue(this.data.base)),this.chan},X.prototype.createAt=function(t){t.innerHTML="";var e=parseInt(this.current.bh),i=parseInt(this.current.bw),s=(s=parseInt(this.current.rh))||128;this.rh=s;var n,o=(o=parseInt(this.current.rw))||2,r=(r=parseInt(this.current.kh))||24,h=(h=parseInt(this.current.kw))||16,a=this.current.pos.toUpperCase(),a=(this.pos=a,this.data||(this.data=new w(this.current.data),this.data.chan=this.chan,this.data.setBase(this.current.base),this.data.setValue(this.current.val)),this.dx=-h/2,this.dy=-(r/2+1),e=e||r+s+2,i=i||(o<h?h:o)+2,this.stlB={display:"inline-block",position:"relative",margin:"0",padding:"0",userSelect:"none",KhtmlUserSelect:"none",MozUserSelect:"none",MsUserSelect:"none",OUserSelect:"none",WebkitUserSelect:"none",cursor:"default"},this.stlB0={borderStyle:"none"},this.stlB1={borderStyle:"none"},this.stlR={display:"inline-block",position:"absolute",margin:"0",padding:"0",borderStyle:"solid",borderWidth:"1px"},this.stlR0={backgroundColor:"#aaa"},this.stlR1={backgroundColor:"#bbb"},this.stlK={display:"inline-block",position:"absolute",margin:"0",padding:"0",borderStyle:"solid",borderWidth:"1px"},this.stlK0={backgroundColor:"#ddd"},this.stlK1={backgroundColor:"#eee"},"E"==a||"W"==a?(this.stlB.width=e+"px",this.stlB.height=i+"px",this.stlR.width=s+"px",this.stlR.height=o+"px",this.stlR.left=(e-s)/2-1+"px",this.stlR.top=(i-o)/2-1+"px",this.stlK.width=r+"px",this.stlK.height=h+"px",this.stlK.top=this.dx+"px"):(this.stlB.width=i+"px",this.stlB.height=e+"px",this.stlR.width=o+"px",this.stlR.height=s+"px",this.stlR.top=(e-s)/2-1+"px",this.stlR.left=(i-o)/2-1+"px",this.stlK.width=h+"px",this.stlK.height=r+"px",this.stlK.left=this.dx+"px"),document.createElement("span")),e=(this.box=a,document.createElement("span")),s=(_(e,u),this.boxSpan=new k(this,a,e,this.stlB,this.stlB0,this.stlB1),document.createElement("span")),i=(this.range=s,document.createElement("span")),o=(_(i,u),this.rangeSpan=new k(this,s,i,this.stlR,this.stlR0,this.stlR1),document.createElement("span"));this.knob=o,this.knobSpan=new k(this,o,o,this.stlK,this.stlK0,this.stlK1),this.spans=[this.boxSpan,this.rangeSpan,this.knobSpan],void 0!==this.current.active&&!this.current.active||(a.addEventListener("touchstart",B),o.addEventListener("mousedown",E(this)),o.addEventListener("touchstart",K(this)),o.addEventListener("touchmove",C(this)),o.addEventListener("touchend",L(this)),o.addEventListener("touchcancel",L(this))),this.current.onCreate&&this.current.onCreate.apply(this),s.appendChild(i),s.appendChild(o),a.appendChild(e),a.appendChild(s),a.ondragstart=f,a.onselectstart=f,t.appendChild(a),!this.at&&1<this.bins.length&&((n=this).resize=function(){n.onResize()},window.addEventListener("resize",this.resize)),this.current.at=t,this.at=t,this.setValue(),_(this.box,void 0===this.dragX?this.stlB0:this.stlB1),_(this.box,this.stlB),_(this.range,void 0===this.dragX?this.stlR0:this.stlR1),_(this.range,this.stlR),_(this.knob,void 0===this.dragX?this.stlK0:this.stlK1),_(this.knob,this.stlK)},X.prototype.getBox=function(){return this.boxSpan},X.prototype.getRange=function(){return this.rangeSpan},X.prototype.getKnob=function(){return this.knobSpan},X.prototype.setValue=function(t){if(void 0===t)t=this.data.val;else if(!this.data.setValue(t))return;t=this.data.val,"N"!=this.pos&&"W"!=this.pos||(t=1-t),t*=this.rh,this.coord=t,t+=this.dy,"N"==this.pos||"S"==this.pos?(this.stlK.top=t+"px",this.knob.style.top=t+"px"):(this.stlK.left=t+"px",this.knob.style.left=t+"px")},X.prototype.onMove=function(t,e){e="N"==this.pos||"S"==this.pos?this.coord+e-this.dragY:this.coord+t-this.dragX;(e=e<0?0:e)>this.rh&&(e=this.rh),this.move(e)},X.prototype.move=function(t){var e;this.coord!=t&&("N"==this.pos||"S"==this.pos?(this.knob.style.top=t+this.dy+"px",this.stlK.top=this.knob.style.top,this.dragY+=t-this.coord):(this.knob.style.left=t+this.dy+"px",this.stlK.left=this.knob.style.left,this.dragX+=t-this.coord),e=t/this.rh,"N"!=this.pos&&"W"!=this.pos||(e=1-e),this.data.setValue(e)&&this.data.emit(this),this.coord=t)},X.prototype.forward=function(t){this.emit(t),this.data.read(t)&&this.setValue()},(R.prototype=new x).channel=function(t){t=r[t];return void 0!==t&&t!=this.chan&&(this.chan=t,this.dataX.chan=t,this.dataY.chan=t,this.setValue(this.dataX.base,this.dataY.base)),this.chan},R.prototype.createAt=function(t){t.innerHTML="";var e=parseInt(this.current.bh),i=parseInt(this.current.bw),s=(s=parseInt(this.current.rh))||128;this.rh=s;var n=(n=parseInt(this.current.rw))||128;this.rw=n;var o,r=(r=parseInt(this.current.kh))||24,h=(h=parseInt(this.current.kw))||16,a=this.current.pos.toUpperCase(),a=(this.pos=a,this.dataX||(this.dataX=new w(this.current.dataX),this.dataY=new w(this.current.dataY),void 0!==this.current.dataX||void 0===this.current.dataY||this.dataY.msb||(this.dataX=new w("mod")),void 0!==this.current.dataY||this.dataX.msb||(this.dataY=new w("mod")),this.dataX.chan=this.chan,this.dataY.chan=this.chan,this.dataX.setBase(this.current.baseX),this.dataY.setBase(this.current.baseY),this.dataX.setValue(this.current.valX),this.dataY.setValue(this.current.valY)),this.dx=-(h/2+1),this.dy=-(r/2+1),e=e||r+s+2,i=i||h+n+2,this.stlB={display:"inline-block",position:"relative",margin:"0",padding:"0",userSelect:"none",KhtmlUserSelect:"none",MozUserSelect:"none",MsUserSelect:"none",OUserSelect:"none",WebkitUserSelect:"none",cursor:"default"},this.stlB0={borderStyle:"none"},this.stlB1={borderStyle:"none"},this.stlR={display:"inline-block",position:"absolute",margin:"0",padding:"0",borderStyle:"solid",borderWidth:"1px"},this.stlR0={backgroundColor:"#aaa"},this.stlR1={backgroundColor:"#bbb"},this.stlK={display:"inline-block",position:"absolute",margin:"0",padding:"0",borderStyle:"solid",borderWidth:"1px"},this.stlK0={backgroundColor:"#ddd"},this.stlK1={backgroundColor:"#eee"},"E"==a||"W"==a?(this.stlB.width=e+"px",this.stlB.height=i+"px",this.stlR.width=s+"px",this.stlR.height=n+"px",this.stlR.left=(e-s)/2-1+"px",this.stlR.top=(i-n)/2-1+"px",this.stlK.width=r+"px",this.stlK.height=h+"px",this.stlK.top=this.dx+"px"):(this.stlB.width=i+"px",this.stlB.height=e+"px",this.stlR.width=n+"px",this.stlR.height=s+"px",this.stlR.top=(e-s)/2-1+"px",this.stlR.left=(i-n)/2-1+"px",this.stlK.width=h+"px",this.stlK.height=r+"px",this.stlK.left=this.dx+"px"),document.createElement("span")),e=(this.box=a,document.createElement("span")),s=(_(e,u),this.boxSpan=new k(this,a,e,this.stlB,this.stlB0,this.stlB1),document.createElement("span")),i=(this.range=s,document.createElement("span")),n=(_(i,u),this.rangeSpan=new k(this,s,i,this.stlR,this.stlR0,this.stlR1),document.createElement("span"));this.knob=n,this.knobSpan=new k(this,n,n,this.stlK,this.stlK0,this.stlK1),this.spans=[this.boxSpan,this.rangeSpan,this.knobSpan],void 0!==this.current.active&&!this.current.active||(a.addEventListener("touchstart",B),n.addEventListener("mousedown",E(this)),n.addEventListener("touchstart",K(this)),n.addEventListener("touchmove",C(this)),n.addEventListener("touchend",L(this)),n.addEventListener("touchcancel",L(this))),this.current.onCreate&&this.current.onCreate.apply(this),s.appendChild(i),s.appendChild(n),a.appendChild(e),a.appendChild(s),a.ondragstart=f,a.onselectstart=f,t.appendChild(a),!this.at&&1<this.bins.length&&((o=this).resize=function(){o.onResize()},window.addEventListener("resize",this.resize)),this.current.at=t,this.at=t,this.setValue(),_(this.box,void 0===this.dragX?this.stlB0:this.stlB1),_(this.box,this.stlB),_(this.range,void 0===this.dragX?this.stlR0:this.stlR1),_(this.range,this.stlR),_(this.knob,void 0===this.dragX?this.stlK0:this.stlK1),_(this.knob,this.stlK)},R.prototype.getBox=function(){return this.boxSpan},R.prototype.getRange=function(){return this.rangeSpan},R.prototype.getKnob=function(){return this.knobSpan},R.prototype.setValue=function(t,e){if(void 0===t)t=this.dataX.val,e=this.dataY.val;else if(!this.dataX.setValue(t)&&!this.dataY.setValue(e))return;t=this.dataX.val,e=this.dataY.val,"N"!=this.pos&&"W"!=this.pos||(e=1-e),"S"!=this.pos&&"W"!=this.pos||(t=1-t),t*=this.rw,e*=this.rh,"N"==this.pos||"S"==this.pos?(this.coordX=t,this.coordY=e):(this.coordX=e,this.coordY=t),t+=this.dx,e+=this.dy,"N"==this.pos||"S"==this.pos?(this.stlK.left=t+"px",this.stlK.top=e+"px"):(this.stlK.top=t+"px",this.stlK.left=e+"px"),this.knob.style.left=this.stlK.left,this.knob.style.top=this.stlK.top},R.prototype.onMove=function(t,e){(t=this.coordX+t-this.dragX)<0&&(t=0),(e=this.coordY+e-this.dragY)<0&&(e=0),"N"==this.pos||"S"==this.pos?(t>this.rw&&(t=this.rw),e>this.rh&&(e=this.rh),this.knob.style.left=t+this.dx+"px",this.knob.style.top=e+this.dy+"px"):(t>this.rh&&(t=this.rh),e>this.rw&&(e=this.rw),this.knob.style.left=t+this.dy+"px",this.knob.style.top=e+this.dx+"px"),this.stlK.left=this.knob.style.left,this.stlK.top=this.knob.style.top,this.dragX+=t-this.coordX,this.dragY+=e-this.coordY,this.coordX=t,this.coordY=e,"E"!=this.pos&&"W"!=this.pos||(t=this.coordY,e=this.coordX),t/=this.rw,e/=this.rh,"N"!=this.pos&&"W"!=this.pos||(e=1-e),"S"!=this.pos&&"W"!=this.pos||(t=1-t),this.dataX.setValue(t)&&this.dataX.emit(this),this.dataY.setValue(e)&&this.dataY.emit(this)},R.prototype.forward=function(t){this.emit(t),(this.dataX.read(t)||this.dataY.read(t))&&this.setValue()},D.prototype._info=function(t){return{type:"html/javascript",name:i(t,"Slider"),manufacturer:"virtual",version:e}},D.prototype._openIn=function(e,t){var i=new X(this._arg);i.connect=function(){e.connect.apply(e,arguments)},i.send=function(){e.send.apply(e,arguments)},i.create(),i.emit=function(t){e._emit(t)},e._info=this._info(t),e._receive=function(t){i.forward(t)},e._close=function(){i._close()},e.settings=function(){return i.settings()},e.getBox=function(){return i.boxSpan},e.getRange=function(){return i.rangeSpan},e.getKnob=function(){return i.knobSpan},e.setValue=function(t){i.setValue(t)},e.channel=function(t){return i.channel(t)},e._resume()},h.input.Slider=function(){1==arguments.length?"string"==typeof arguments[0]?t=arguments[0]:e=arguments[0]:(t=arguments[0],e=arguments[1]);var t,e,i=new D;return i._arg=e,h.lib.openMidiIn(t,i)},h.input.Slider.register=function(){1==arguments.length?"string"==typeof arguments[0]?t=arguments[0]:e=arguments[0]:(t=arguments[0],e=arguments[1]);var t,e,i=new D;return i._arg=e,h.lib.registerMidiIn(t,i)},H.prototype._info=function(t){return{type:"html/javascript",name:i(t,"Pad"),manufacturer:"virtual",version:e}},H.prototype._openIn=function(e,t){var i=new R(this._arg);i.connect=function(){e.connect.apply(e,arguments)},i.send=function(){e.send.apply(e,arguments)},i.create(),i.emit=function(t){e._emit(t)},e._info=this._info(t),e._receive=function(t){i.forward(t)},e._close=function(){i._close()},e.settings=function(){return i.settings()},e.getBox=function(){return i.boxSpan},e.getRange=function(){return i.rangeSpan},e.getKnob=function(){return i.knobSpan},e.setValue=function(t){i.setValue(t)},e.channel=function(t){return i.channel(t)},e._resume()},h.input.Pad=function(){1==arguments.length?"string"==typeof arguments[0]?t=arguments[0]:e=arguments[0]:(t=arguments[0],e=arguments[1]);var t,e,i=new H;return i._arg=e,h.lib.openMidiIn(t,i)},h.input.Pad.register=function(){1==arguments.length?"string"==typeof arguments[0]?t=arguments[0]:e=arguments[0]:(t=arguments[0],e=arguments[1]);var t,e,i=new H;return i._arg=e,h.lib.registerMidiIn(t,i)}}function i(t,e){return t||e}function a(t){var e,i={};for(e in t)i[e]=t[e];return i}function o(t){return 65<=t&&t<=90?"Key"+String.fromCharCode(t):48<=t&&t<=57?"Digit"+String.fromCharCode(t):{9:"Tab",8:"Backspace",27:"Escape",32:"Space",59:"Semicolon",171:"Equal",173:"Minus",188:"Comma",190:"Period",191:"Slash",192:"Backquote",219:"BracketLeft",220:"Backslash",221:"BracketRight",222:"Quote"}[t]}function s(t){for(var e in this.notes={},this.playing=[],void 0!==(t=void 0===t?{}:t).mpe?(h.MPE.validate(t.mpe),this.mpe=t.mpe,this.chan=t.mpe[0]):(this.chan=r[t.chan],void 0===this.chan&&(this.chan=0)),t){var i=function(t){var e=t.toUpperCase();if(1==e.length){var i=e.charCodeAt(0);if(65<=i&&i<=90)return"Key"+e;if(48<=i&&i<=57)return"Digit"+e}return(e={ESC:"Escape",TAB:"Tab",BSP:"Backspace","-":"Minus",_:"Minus","+":"Equal","=":"Equal","[":"BracketLeft","{":"BracketLeft","]":"BracketRight","}":"BracketRight",";":"Semicolon",":":"Semicolon","'":"Quote",'"':"Quote","`":"Backquote","~":"Backquote","|":"Backslash","\\":"Backslash",",":"Comma","<":"Comma",".":"Period",">":"Period","/":"Slash","?":"Slash"," ":"Space"}[e])||t}(e);"function"==typeof t[e]?this.notes[i]=t[e]:(e=h.MIDI.noteValue(t[e]),void 0!==i&&void 0!==e&&(this.notes[i]=e))}var s=this;this.keydown=function(t){var e=t.code?s.notes[t.code]:s.notes[o(t.keyCode)];void 0!==e&&(t.preventDefault(),"function"==typeof e?e.apply(s,[!0]):s.playing[e]||(s.playing[e]=!0,s.noteOn(e)))},this.keyup=function(t){var e=t.code?s.notes[t.code]:s.notes[o(t.keyCode)];void 0!==e&&(t.preventDefault(),"function"==typeof e&&e.apply(s,[!1]),s.playing[e])&&(s.playing[e]=void 0,s.noteOff(e))},"string"==typeof t.at&&(this.at=document.getElementById(t.at));try{this.at.addEventListener("keydown",this.keydown),this.at.addEventListener("keyup",this.keyup),(!this.at.tabIndex||this.at.tabIndex<0)&&(this.at.tabIndex=0)}catch(t){document.addEventListener("keydown",this.keydown),document.addEventListener("keyup",this.keyup),this.at=document}this._close=function(){for(var t in this.at.removeEventListener("keydown",this.keydown),this.at.removeEventListener("keyup",this.keyup),s.playing)s.noteOff(t)}}function c(){}function p(t){return void 0===t.buttons||t.buttons!=n?t:(t.stopPropagation(),0==t.button?{buttons:1^n}:1==t.button?{buttons:4^n}:2==t.button?{buttons:2^n}:void 0)}function l(t){return void 0===t.buttons?!t.button:1&t.buttons}function d(t){return void 0===t.buttons?!t.button:!(1&t.buttons)}function f(){return!1}function _(t,e){if(t)for(var i in e)t.style[i]=e[i]}function M(t,e){return(e?[0,1,1,2,2,3,4,4,5,5,6,6]:[0,0,1,1,2,3,3,4,4,5,5,6])[(t=h.MIDI.noteValue(t))%12]+7*Math.floor(t/12)}function S(t){return 12*Math.floor(t/7)+{0:0,1:2,2:4,3:5,4:7,5:9,6:11}[t%7]}function v(e,i){return function(t){e.mouseDown&&"M"==e.playing[i]&&!function(t,e){for(;t;t=t.parentNode)if(t==e)return 1}(t.relatedTarget,this)&&(e.playing[i]=void 0,e.release(i)),n=t.buttons}}function y(t){this.bins=[],this.params={0:{}};var e,i={from:"C4",to:"E6",ww:42,bw:24,wl:150,bl:100,pos:"N"};for(e in void 0!==(t=void 0===t?{}:t).mpe?(h.MPE.validate(t.mpe),this.mpe=t.mpe,this.chan=t.mpe[0]):(this.chan=r[t.chan],void 0===this.chan&&(this.chan=0)),t)e==parseInt(e)?this.params[e]=a(t[e]):"chan"!=e&&("from"!=e&&"to"!=e||void 0!==h.MIDI.noteValue(t[e]))&&(i[e]=t[e]);for(e in this.params){for(var s in this.bins.push(e),i)"from"!=s&&"to"!=s||void 0!==this.params[e][s]&&void 0!==h.MIDI.noteValue(this.params[e][s])||(this.params[e][s]=i[s]),s in this.params[e]||(this.params[e][s]=i[s]);var n=this.params[e].from,o=this.params[e].to;h.MIDI.noteValue(n)>h.MIDI.noteValue(o)&&(this.params[e].from=o,this.params[e].to=n)}this.bins.sort(function(t,e){return t-e})}function m(t,e){return t=(t+"").trim(),e=(e+"").trim(),t.endsWith("%")&&e.endsWith("%")?"%":"px"}function b(t){this.piano=t,this.keys=[]}function g(){}function w(t){if(this.base=.5,this.val=.5,this.msb=0,this.lsb=0,this.chan=0,t instanceof Array){if(1!=t.length&&2!=t.length)return;if(2==t.length){if(t[1]!=parseInt(t[1])||t[1]<1||127<t[1])return;this.msb=t[0],t[1]!=t[0]&&(this.lsb=t[1])}else this.msb=t[0]}else if(t==parseInt(t)){if(t<1||127<t)return;this.msb=t}else{t={mod:[1,33],breath:[2,34],foot:[4,36],portamento:[5,37],volume:[7,39],balance:[8,40],pan:[10,42],expression:[11,43],effect1:[12,44],effect2:[13,45]}[t];t&&(this.msb=t[0],this.lsb=t[1])}this.msb&&7!=this.msb&&8!=this.msb&&10!=this.msb&&(this.base=0),this.val=-1,this.setValue(this.base)}function k(t,e,i,s,n,o){this.ctrl=t,this.span=e,this.inner=i,this.stl=s,this.stl0=n,this.stl1=o}function x(){}function I(t,e){for(var i in this.bins=[],this.params={0:{}},void 0===e&&(e={}),this.chan=r[(t=void 0===t?{}:t).chan],void 0===this.chan&&(this.chan=0),t)i==parseInt(i)?this.params[i]=a(t[i]):"chan"!=i&&(e[i]=t[i]);for(i in this.params)for(var s in this.bins.push(i),e)"from"!=s&&"to"!=s||void 0!==M(this.params[i][s])||(this.params[i][s]=e[s]),s in this.params[i]||(this.params[i][s]=e[s]);this.bins.sort(function(t,e){return t-e})}function E(e){return function(t){n=t.buttons,l(t)&&e.onMouseDown(t)}}function K(e){return function(t){e.onTouchStart(t)}}function C(e){return function(t){e.onTouchMove(t)}}function L(e){return function(t){e.onTouchEnd(t)}}function B(t){t.preventDefault()}function X(t){I.call(this,t,{pos:"N",rw:2,rh:128,kw:24,kh:16})}function R(t){I.call(this,t,{pos:"N",rw:128,rh:128,kw:24,kh:16})}function D(){}function H(){}});