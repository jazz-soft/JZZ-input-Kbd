!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e:"function"==typeof define&&define.amd?define("JZZ.midi.Kbd",["JZZ"],e):e(JZZ)}(0,function(t){if(t){t.input||(t.input={});for(var e,i="1.0.0",n={" ":32,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,"+":61,"=":61,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,_:173,"-":173,"[":219,"{":219,"]":221,"}":221,"|":220,"\\":220,"`":192,"~":192,";":59,":":59,"'":222,'"':222,",":188,"<":188,".":190,">":190,"/":191,"?":191},s={a:10,b:11,c:12,d:13,e:14,f:15,A:10,B:11,C:12,D:13,E:14,F:15},o=0;o<16;o++)s[o]=o;a.prototype._info=function(t){return{type:"html/javascript",name:r(t,"ASCII"),manufacturer:"virtual",version:i}},a.prototype._openIn=function(e,i){var o=new function(e){for(var i in this.notes={},this.playing=[],void 0===e&&(e={}),this.chan=s[e.chan],void 0===this.chan&&(this.chan=0),e){var o=n[i],r=t.MIDI.noteValue(e[i]);void 0!==o&&void 0!==r&&(this.notes[o]=r)}var h=this;this.keydown=function(t){var e=h.notes[t.keyCode];void 0!==e&&(t.preventDefault(),h.playing[e]||(h.playing[e]=!0,h.noteOn(e)))},this.keyup=function(t){var e=h.notes[t.keyCode];void 0!==e&&(t.preventDefault(),h.playing[e]&&(h.playing[e]=void 0,h.noteOff(e)))},"string"==typeof e.at&&(this.at=document.getElementById(e.at));try{this.at.addEventListener("keydown",this.keydown),this.at.addEventListener("keyup",this.keyup),(!this.at.tabIndex||this.at.tabIndex<0)&&(this.at.tabIndex=0)}catch(t){document.addEventListener("keydown",this.keydown),document.addEventListener("keyup",this.keyup),this.at=document}this._close=function(){for(var t in this.at.removeEventListener("keydown",this.keydown),this.at.removeEventListener("keyup",this.keyup),h.playing)h.noteOff(t)}}(this._arg);o.noteOn=function(i){e._emit(t.MIDI(144+this.chan,i,127))},o.noteOff=function(i){e._emit(t.MIDI(128+this.chan,i,127))},e._info=this._info(i),e._close=function(){o._close()},e._resume()},t.input.ASCII=function(){var e,i;1==arguments.length?"string"==typeof arguments[0]?e=arguments[0]:i=arguments[0]:(e=arguments[0],i=arguments[1]);var n=new a;return n._arg=i,t.lib.openMidiIn(e,n)},t.input.ASCII.register=function(){var e,i;1==arguments.length?"string"==typeof arguments[0]?e=arguments[0]:i=arguments[0]:(e=arguments[0],i=arguments[1]);var n=new a;return n._arg=i,t.lib.registerMidiIn(e,n)},g.prototype._close=function(){for(var t in this.playing)"M"!=this.playing[t]&&"T"!=this.playing[t]||this.noteOff(t);this.resize&&window.removeEventListener("resize",this.resize),this.cleanup()},g.prototype.press=function(t){l(this.keys[t],this.stl1[t]),l(this.keys[t],this.locs[t]),this.noteOn(t)},g.prototype.release=function(t){l(this.keys[t],this.stl0[t]),l(this.keys[t],this.locs[t]),this.noteOff(t)},g.prototype.forward=function(t){var e=t[1];if(t.getChannel()==this.chan){var i=t[0]>>4;if(t.isNoteOn())this.playing[e]="E",l(this.keys[e],this.stl1[e]),l(this.keys[e],this.locs[e]);else if(t.isNoteOff())this.playing[e]=void 0,l(this.keys[e],this.stl0[e]),l(this.keys[e],this.locs[e]);else if(11==i&&(120==e||123==e))for(var n in this.playing)this.playing[n]&&(this.playing[n]=void 0,l(this.keys[n],this.stl0[n]),l(this.keys[n],this.locs[n]))}this.emit(t)},g.prototype.findKey=function(t,e,i){for(var n in this.keys)for(var s=document.elementFromPoint(t,e);s;s=s.parentNode)if(this.keys[n]==s)return void(i[n]=!0)},g.prototype.create=function(){for(var t=0,e=0;e<this.bins.length&&this.bins[e]<=window.innerWidth;e++)t=this.bins[e];this.current=this.params[t],this.createCurrent()},g.prototype.createCurrent=function(){if(this.cleanup(),this.keys={},this.locs={},this.stl0={},this.stl1={},this.playing={},this.touches={},this.current.keys)this.createWithKeys(this.current.keys);else{"string"==typeof this.current.at&&(this.current.at=document.getElementById(this.current.at));try{this.createAt(this.current.at)}catch(t){this.bottom||(this.bottom=document.createElement("div"),document.body.appendChild(this.bottom)),this.createAt(this.bottom)}}},g.prototype.createWithKeys=function(e){for(var i in e){var n=t.MIDI.noteValue(e[i][1]),s=e[i][0];"string"==typeof s&&(s=document.getElementById(s)),this.keys[n]=s,this.locs[n]={},this.stl0[n]={},this.stl1[n]={}}this.current.onCreate&&this.current.onCreate.apply(this),this.setListeners()},g.prototype.createAt=function(t){t.innerHTML="";var e,i,n,s=this.current.pos.toUpperCase(),o=d(this.current.from),r=d(this.current.to,!0),h=r-o+1,a=h*this.current.ww+1,u=this.current.wl+1,c=this.current.ww-1,p=this.current.wl-1,v=this.current.bw-1,y=this.current.bl-1,m="N"!=s^!this.current.rev,w="E"!=s^!this.current.rev,g=document.createElement("span");g.style.display="inline-block",g.style.position="relative",g.style.margin="0px",g.style.padding="0px",g.style.borderStyle="none",g.style.userSelect="none",g.style.MozUserSelect="none",g.style.WebkitUserSelect="none",g.style.MsUserSelect="none",g.style.KhtmlUserSelect="none",g.style.cursor="default","E"==s||"W"==s?(g.style.width=u+"px",g.style.height=a+"px"):(g.style.width=a+"px",g.style.height=u+"px");for(var k=0;k<h;k++)e=f(k+o),i=document.createElement("span"),this.keys[e]=i,n={display:"inline-block",position:"absolute",margin:"0px",padding:"0px",borderStyle:"solid",borderWidth:"1px"},this.locs[e]=n,"E"==s||"W"==s?(n.width=p+"px",n.height=c+"px",n.left="0px",n[w?"top":"bottom"]=this.current.ww*k+"px"):(n.width=c+"px",n.height=p+"px",n.top="0px",n[m?"left":"right"]=this.current.ww*k+"px",n.verticalAlign="top"),this.stl0[e]={backgroundColor:"#fff",borderColor:"#000"},this.stl1[e]={backgroundColor:"#aaa",borderColor:"#000"},l(i,this.stl0[e]),l(i,n),g.appendChild(i);var b=Math.ceil(this.current.ww-3*this.current.bw/4);(b+this.current.ww)%2&&b--;var I=f(o)+1,E=f(r);for(e=I;e<E;e++){var M,H=e%12,L=Math.floor(e/12);if(1==H)M=Math.floor(this.current.ww*(7*L+1.5-o))-b/2-this.current.bw;else if(3==H)M=Math.floor(this.current.ww*(7*L+1.5-o)+b/2);else if(6==H)M=this.current.ww*(7*L+5-o)-Math.floor(this.current.bw/2)-b-this.current.bw;else if(8==H)M=this.current.ww*(7*L+5-o)-Math.floor(this.current.bw/2);else{if(10!=H)continue;M=this.current.ww*(7*L+5-o)-Math.floor(this.current.bw/2)+b+this.current.bw}i=document.createElement("span"),this.keys[e]=i,n={display:"inline-block",position:"absolute",margin:"0px",padding:"0px",borderStyle:"solid",borderWidth:"1px"},this.locs[e]=n,"E"==s||"W"==s?(n.width=y+"px",n.height=v+"px",n["E"==s?"right":"left"]="0px",n[w?"top":"bottom"]=M+"px"):(n.width=v+"px",n.height=y+"px",n["N"==s?"top":"bottom"]="0px",n[m?"left":"right"]=M+"px"),this.stl0[e]={backgroundColor:"#000",borderColor:"#000"},this.stl1[e]={backgroundColor:"#888",borderColor:"#000"},l(i,this.stl0[e]),l(i,n),g.appendChild(i)}this.current.onCreate&&this.current.onCreate.apply(this),t.appendChild(g),this.current.at=t,this.at=t,this.setListeners()},g.prototype.setListeners=function(){var t,i;if(void 0===this.current.active||this.current.active)for(var n in this.watchButtons=function(t){e=t.buttons},this.mouseUpHandle=(i=this,function(t){c(t=u(t))&&(i.mouseDown=!1)}),window.addEventListener("mousedown",this.watchButtons),window.addEventListener("mousemove",this.watchButtons),window.addEventListener("mouseup",this.mouseUpHandle),this.touchHandle=(t=this,function(e){e.preventDefault();var i={};for(var n in e.touches)t.findKey(e.touches[n].clientX,e.touches[n].clientY,i);var s={};for(var o in i)o in t.touches?s[o]=!0:void 0===t.playing[o]&&(t.playing[o]="T",t.press(o),s[o]=!0);for(var o in t.touches)o in i||(t.playing[o]=void 0,t.release(o));t.touches=s}),this.mouseDownH=[],this.mouseOverH=[],this.mouseOutH=[],this.mouseUpH=[],this.keys)this.mouseDownH[n]=v(this,n),this.mouseOverH[n]=y(this,n),this.mouseOutH[n]=m(this,n),this.mouseUpH[n]=w(this,n),this.keys[n].addEventListener("mousedown",this.mouseDownH[n]),this.keys[n].addEventListener("mouseover",this.mouseOverH[n]),this.keys[n].addEventListener("mouseout",this.mouseOutH[n]),this.keys[n].addEventListener("mouseup",this.mouseUpH[n]),this.keys[n].addEventListener("touchstart",this.touchHandle),this.keys[n].addEventListener("touchmove",this.touchHandle),this.keys[n].addEventListener("touchend",this.touchHandle);for(var n in this.keys)this.keys[n].ondragstart=p,this.keys[n].onselectstart=p;if(!this.resize&&this.bins.length>1){var s=this;this.resize=function(){s.onResize()},window.addEventListener("resize",this.resize)}},g.prototype.cleanup=function(){for(var t in this.watchButtons&&(window.removeEventListener("mousedown",this.watchButtons),window.removeEventListener("mousemove",this.watchButtons),window.removeEventListener("mouseup",this.mouseUpHandle)),this.keys)this.mouseDownH[t]&&this.keys[t].removeEventListener("mousedown",this.mouseDownH[t]),this.mouseOverH[t]&&this.keys[t].removeEventListener("mouseover",this.mouseOverH[t]),this.mouseOutH[t]&&this.keys[t].removeEventListener("mouseout",this.mouseOutH[t]),this.mouseUpH[t]&&this.keys[t].removeEventListener("mouseup",this.mouseUpH[t]),this.touchHandle&&(this.keys[t].removeEventListener("touchstart",this.touchHandle),this.keys[t].removeEventListener("touchmove",this.touchHandle),this.keys[t].removeEventListener("touchend",this.touchHandle));this.at&&(this.at.innerHTML="")},g.prototype.settings=function(){return h(this.current)},g.prototype.onResize=function(){for(var t=0,e=0;e<this.bins.length&&this.bins[e]<=window.innerWidth;e++)t=this.bins[e];this.current!=this.params[t]&&(this.current=this.params[t],this.createCurrent())},g.prototype.getKey=function(e){var i=new k(this),n=t.MIDI.noteValue(e);return void 0!==this.keys[n]&&i.keys.push(n),i},g.prototype.getKeys=function(e,i){var n=new k(this),s=void 0===e?void 0:t.MIDI.noteValue(e),o=void 0===i?void 0:t.MIDI.noteValue(i);if(void 0!==s&&void 0!==o&&o<s){var r=s;s=o,o=r}for(var h in this.keys)void 0!==s&&h<s||void 0!==o&&h>o||n.keys.push(h);return n},g.prototype.getWhiteKeys=function(e,i){var n=new k(this),s=void 0===e?void 0:t.MIDI.noteValue(e),o=void 0===i?void 0:t.MIDI.noteValue(i);if(void 0!==s&&void 0!==o&&o<s){var r=s;s=o,o=r}for(var h in this.keys)if(!(void 0!==s&&h<s||void 0!==o&&h>o)){var a=h%12;1!=a&&3!=a&&6!=a&&8!=a&&10!=a&&n.keys.push(h)}return n},g.prototype.getBlackKeys=function(e,i){var n=new k(this),s=void 0===e?void 0:t.MIDI.noteValue(e),o=void 0===i?void 0:t.MIDI.noteValue(i);if(void 0!==s&&void 0!==o&&o<s){var r=s;s=o,o=r}for(var h in this.keys)if(!(void 0!==s&&h<s||void 0!==o&&h>o)){var a=h%12;1!=a&&3!=a&&6!=a&&8!=a&&10!=a||n.keys.push(h)}return n},k.prototype.setInnerHTML=function(t){for(var e in this.keys)this.piano.keys[this.keys[e]].innerHTML=t;return this},k.prototype.setStyle=function(t,e){for(var i in void 0===e&&(e=t),this.keys){var n=this.keys[i];for(var s in t)this.piano.stl0[n][s]=t[s];for(var s in e)this.piano.stl1[n][s]=e[s];l(this.piano.keys[n],this.piano.playing[n]?this.piano.stl1[n]:this.piano.stl0[n]),l(this.piano.keys[n],this.piano.locs[n])}return this},b.prototype._info=function(t){return{type:"html/javascript",name:r(t,"Kbd"),manufacturer:"virtual",version:i}},b.prototype._openIn=function(e,i){var n=new g(this._arg);n.send=function(){e.send.apply(e,arguments)},n.connect=function(){e.connect.apply(e,arguments)},n.create(),n.noteOn=function(i){e._emit(t.MIDI(144+this.chan,i,127))},n.noteOff=function(i){e._emit(t.MIDI(128+this.chan,i,127))},n.emit=function(t){e._emit(t)},e._info=this._info(i),e._receive=function(t){n.forward(t)},e._close=function(){n._close()},e.settings=function(){return n.settings()},e.getKey=function(t){return n.getKey(t)},e.getKeys=function(t,e){return n.getKeys(t,e)},e.getWhiteKeys=function(t,e){return n.getWhiteKeys(t,e)},e.getBlackKeys=function(t,e){return n.getBlackKeys(t,e)},e._resume()},t.input.Kbd=function(){var e,i;1==arguments.length?"string"==typeof arguments[0]?e=arguments[0]:i=arguments[0]:(e=arguments[0],i=arguments[1]);var n=new b;return n._arg=i,t.lib.openMidiIn(e,n)},t.input.Kbd.register=function(){var e,i;1==arguments.length?"string"==typeof arguments[0]?e=arguments[0]:i=arguments[0]:(e=arguments[0],i=arguments[1]);var n=new b;return n._arg=i,t.lib.registerMidiIn(e,n)}}function r(t,e){return t||e}function h(t){var e={};for(var i in t)e[i]=t[i];return e}function a(){}function u(t){return void 0===t.buttons||t.buttons!=e?t:(t.stopPropagation(),0==t.button?{buttons:1^e}:1==t.button?{buttons:4^e}:2==t.button?{buttons:2^e}:void 0)}function c(t){return void 0===t.buttons?!t.button:!(1&t.buttons)}function p(){return!1}function l(t,e){for(var i in e)t.style[i]=e[i]}function d(e,i){return e=t.MIDI.noteValue(e),(i?[0,1,1,2,2,3,4,4,5,5,6,6]:[0,0,1,1,2,3,3,4,4,5,5,6])[e%12]+7*Math.floor(e/12)}function f(t){return 12*Math.floor(t/7)+{0:0,1:2,2:4,3:5,4:7,5:9,6:11}[t%7]}function v(t,i){return function(n){var s;(void 0===(s=n).buttons?!s.button:1&s.buttons)&&!t.playing[i]&&(t.mouseDown=!0,t.playing[i]="M",t.press(i)),e=n.buttons}}function y(t,i){return function(n){t.mouseDown&&!t.playing[i]&&(t.playing[i]="M",t.press(i)),e=n.buttons}}function m(t,i){return function(n){t.mouseDown&&"M"==t.playing[i]&&!function(t,e){for(;t;t=t.parentNode)if(t==e)return!0;return!1}(n.relatedTarget,this)&&(t.playing[i]=void 0,t.release(i)),e=n.buttons}}function w(t,e){return function(i){c(i=u(i))&&t.mouseDown&&"M"==t.playing[e]&&(t.playing[e]=void 0,t.release(e),t.mouseDown=!1)}}function g(e){this.bins=[],this.params={0:{}};var i,n={from:"C4",to:"E6",ww:42,bw:24,wl:150,bl:100,pos:"N"};for(i in void 0===e&&(e={}),this.chan=s[e.chan],void 0===this.chan&&(this.chan=0),e)if(i==parseInt(i))this.params[i]=h(e[i]);else{if("chan"==i)continue;if(("from"==i||"to"==i)&&void 0===t.MIDI.noteValue(e[i]))continue;n[i]=e[i]}for(i in this.params){for(var o in this.bins.push(i),n)"from"!=o&&"to"!=o||void 0!==this.params[i][o]&&void 0!==t.MIDI.noteValue(this.params[i][o])||(this.params[i][o]=n[o]),o in this.params[i]||(this.params[i][o]=n[o]);var r=this.params[i].from,a=this.params[i].to;t.MIDI.noteValue(r)>t.MIDI.noteValue(a)&&(this.params[i].from=a,this.params[i].to=r)}this.bins.sort(function(t,e){return t-e})}function k(t){this.piano=t,this.keys=[]}function b(){}});